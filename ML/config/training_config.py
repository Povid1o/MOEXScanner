"""
üéõÔ∏è –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø –û–ë–£–ß–ï–ù–ò–Ø –ú–û–î–ï–õ–ò

–≠—Ç–æ—Ç —Ñ–∞–π–ª —Å–æ–¥–µ—Ä–∂–∏—Ç –í–°–ï –ø–∞—Ä–∞–º–µ—Ç—Ä—ã, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–∂–Ω–æ –º–µ–Ω—è—Ç—å –¥–ª—è —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–æ–≤.
–ò–∑–º–µ–Ω–∏—Ç–µ –Ω—É–∂–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏ –∑–∞–ø—É—Å—Ç–∏—Ç–µ: python run_full_pipeline.py --skip-features

–ê–≤—Ç–æ—Ä: ML Pipeline v2.0
"""

from datetime import datetime, timedelta

# ============================================================================
# üìÖ TRAIN/TEST SPLIT
# ============================================================================

# –í–∞—Ä–∏–∞–Ω—Ç 1: –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –¥–∞—Ç–∞
# TRAIN_CUTOFF_DATE = '2024-01-01'  # ~60/40 split

# –í–∞—Ä–∏–∞–Ω—Ç 2: –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è –¥–∞—Ç–∞ (–ø–æ—Å–ª–µ–¥–Ω–∏–µ N –¥–Ω–µ–π = test)
# TEST_DAYS = 365  # –ü–æ—Å–ª–µ–¥–Ω–∏–π –≥–æ–¥ = test

# –í–∞—Ä–∏–∞–Ω—Ç 3: –ü—Ä–æ—Ü–µ–Ω—Ç–Ω–æ–µ —Å–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)
TRAIN_TEST_RATIO = 0.70  # 70% train, 30% test (–±—ã–ª–æ 60/40)

# –¢–µ–∫—É—â–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞:
TRAIN_CUTOFF_DATE = '2024-06-01'  # –°–¥–≤–∏–Ω—É–ª–∏ –Ω–∞ 6 –º–µ—Å—è—Ü–µ–≤ –≤–ø–µ—Ä—ë–¥ ‚Üí –±–æ–ª—å—à–µ train –¥–∞–Ω–Ω—ã—Ö


# ============================================================================
# üéØ –¶–ï–õ–ï–í–ê–Ø –ü–ï–†–ï–ú–ï–ù–ù–ê–Ø
# ============================================================================

TARGET_HORIZON = 5  # –ì–æ—Ä–∏–∑–æ–Ω—Ç –ø—Ä–æ–≥–Ω–æ–∑–∞ –≤ –¥–Ω—è—Ö (1, 5, 10, 20)
TARGET_COL = f'target_vol_{TARGET_HORIZON}d'


# ============================================================================
# üå≥ –ì–ò–ü–ï–†–ü–ê–†–ê–ú–ï–¢–†–´ LIGHTGBM
# ============================================================================

LGBM_PARAMS = {
    # –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞
    'boosting_type': 'gbdt',
    'objective': 'quantile',
    'metric': 'quantile',
    
    # –°–ª–æ–∂–Ω–æ—Å—Ç—å –º–æ–¥–µ–ª–∏
    'num_leaves': 63,          # –ë–æ–ª—å—à–µ = —Å–ª–æ–∂–Ω–µ–µ (31, 63, 127)
    'max_depth': -1,           # -1 = –±–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è (–∏–ª–∏ 6, 8, 10)
    'min_child_samples': 20,   # –ú–∏–Ω. –∑–∞–ø–∏—Å–µ–π –≤ –ª–∏—Å—Ç–µ (10, 20, 50, 100)
    
    # –°–∫–æ—Ä–æ—Å—Ç—å –æ–±—É—á–µ–Ω–∏—è
    'learning_rate': 0.05,     # –ú–µ–Ω—å—à–µ = –º–µ–¥–ª–µ–Ω–Ω–µ–µ, –Ω–æ —Å—Ç–∞–±–∏–ª—å–Ω–µ–µ (0.01, 0.05, 0.1)
    
    # –†–µ–≥—É–ª—è—Ä–∏–∑–∞—Ü–∏—è (–ü–†–û–¢–ò–í –ü–ï–†–ï–û–ë–£–ß–ï–ù–ò–Ø)
    'lambda_l1': 0.1,          # L1 reg (0, 0.1, 0.5, 1.0)
    'lambda_l2': 0.1,          # L2 reg (0, 0.1, 0.5, 1.0)
    'feature_fraction': 0.8,   # –î–æ–ª—è –ø—Ä–∏–∑–Ω–∞–∫–æ–≤ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –¥–µ—Ä–µ–≤–∞ (0.6, 0.8, 1.0)
    'bagging_fraction': 0.8,   # –î–æ–ª—è —Å—Ç—Ä–æ–∫ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –¥–µ—Ä–µ–≤–∞ (0.6, 0.8, 1.0)
    'bagging_freq': 5,         # –ß–∞—Å—Ç–æ—Ç–∞ bagging (1, 5, 10)
    
    # –ü—Ä–æ—á–µ–µ
    'verbose': -1,
    'n_jobs': -1,
    'seed': 42
}

# –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –æ–±—É—á–µ–Ω–∏—è
NUM_BOOST_ROUND = 1000        # –ú–∞–∫—Å. –∏—Ç–µ—Ä–∞—Ü–∏–π (500, 1000, 2000)
EARLY_STOPPING_ROUNDS = 50    # –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –µ—Å–ª–∏ –Ω–µ—Ç —É–ª—É—á—à–µ–Ω–∏—è (30, 50, 100)


# ============================================================================
# üìä –ö–í–ê–ù–¢–ò–õ–ò
# ============================================================================

# –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π 68% –∏–Ω—Ç–µ—Ä–≤–∞–ª (¬±1 sigma)
QUANTILES = [0.16, 0.50, 0.84]

# –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞: 80% –∏–Ω—Ç–µ—Ä–≤–∞–ª
# QUANTILES = [0.10, 0.50, 0.90]

# –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞: 95% –∏–Ω—Ç–µ—Ä–≤–∞–ª
# QUANTILES = [0.025, 0.50, 0.975]


# ============================================================================
# üè∑Ô∏è –ö–ê–¢–ï–ì–û–†–ò–ê–õ–¨–ù–´–ï –ü–†–ò–ó–ù–ê–ö–ò
# ============================================================================

CATEGORICAL_FEATURES = [
    'ticker_id',       # ID —Ç–∏–∫–µ—Ä–∞ (–º–æ–∂–µ—Ç –≤—ã–∑—ã–≤–∞—Ç—å –ø–µ—Ä–µ–æ–±—É—á–µ–Ω–∏–µ!)
    'sector_id',       # ID —Å–µ–∫—Ç–æ—Ä–∞
    'is_month_end',
    'is_month_start',
    'day_of_week',
    'vp_above_va',
    'volume_spike',
    'trend_signal',
    'price_position_ma'
]

# –≠–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç: —É–±—Ä–∞—Ç—å ticker_id —á—Ç–æ–±—ã –º–æ–¥–µ–ª—å –Ω–µ "–∑–∞–ø–æ–º–∏–Ω–∞–ª–∞" —Ç–∏–∫–µ—Ä—ã
# CATEGORICAL_FEATURES = [
#     'sector_id',
#     'is_month_end',
#     ...
# ]


# ============================================================================
# üö´ –ò–°–ö–õ–Æ–ß–ê–ï–ú–´–ï –¢–ò–ö–ï–†–´ (–ø–ª–æ—Ö–æ —Ä–∞–±–æ—Ç–∞—é—Ç)
# ============================================================================

EXCLUDE_TICKERS = [
    # 'FIVE',   # r=0.077 - –æ—á–µ–Ω—å –ø–ª–æ—Ö–æ
    # 'BELU',   # r=0.241 - –ø–ª–æ—Ö–æ
    # 'YNDX',   # r=0.343 - —Å–ª–∞–±–æ
    # 'LENT',   # r=0.427 - —Å–ª–∞–±–æ
]


# ============================================================================
# üß™ PRESET-–´ –î–õ–Ø –≠–ö–°–ü–ï–†–ò–ú–ï–ù–¢–û–í
# ============================================================================

# –ü—Ä–µ—Å–µ—Ç 1: –ë–∞–∑–æ–≤—ã–π (—Ç–µ–∫—É—â–∏–π)
PRESET_BASELINE = {
    'train_cutoff': '2024-01-01',
    'num_leaves': 63,
    'learning_rate': 0.05,
    'lambda_l1': 0.1,
    'lambda_l2': 0.1,
    'min_child_samples': 20,
}

# –ü—Ä–µ—Å–µ—Ç 2: –ë–æ–ª—å—à–µ train –¥–∞–Ω–Ω—ã—Ö (70/30)
PRESET_MORE_TRAIN = {
    'train_cutoff': '2024-06-01',  # +6 –º–µ—Å—è—Ü–µ–≤ train
    'num_leaves': 63,
    'learning_rate': 0.05,
    'lambda_l1': 0.1,
    'lambda_l2': 0.1,
    'min_child_samples': 20,
}

# –ü—Ä–µ—Å–µ—Ç 3: –°–∏–ª—å–Ω–∞—è —Ä–µ–≥—É–ª—è—Ä–∏–∑–∞—Ü–∏—è (–ø—Ä–æ—Ç–∏–≤ –ø–µ—Ä–µ–æ–±—É—á–µ–Ω–∏—è)
PRESET_REGULARIZED = {
    'train_cutoff': '2024-06-01',
    'num_leaves': 31,             # –ú–µ–Ω—å—à–µ
    'learning_rate': 0.03,        # –ú–µ–¥–ª–µ–Ω–Ω–µ–µ
    'lambda_l1': 0.5,             # –°–∏–ª—å–Ω–µ–µ
    'lambda_l2': 1.0,             # –°–∏–ª—å–Ω–µ–µ
    'min_child_samples': 50,      # –ë–æ–ª—å—à–µ
}

# –ü—Ä–µ—Å–µ—Ç 4: –ë–µ–∑ ticker_id (—á–∏—Å—Ç–∞—è –≥–µ–Ω–µ—Ä–∞–ª–∏–∑–∞—Ü–∏—è)
PRESET_NO_TICKER = {
    'train_cutoff': '2024-06-01',
    'num_leaves': 63,
    'learning_rate': 0.05,
    'lambda_l1': 0.3,
    'lambda_l2': 0.3,
    'min_child_samples': 30,
    'exclude_features': ['ticker_id'],
}


# ============================================================================
# üìù –ê–ö–¢–ò–í–ù–´–ô –ü–†–ï–°–ï–¢ (–∏–∑–º–µ–Ω–∏—Ç–µ –∑–¥–µ—Å—å!)
# ============================================================================

ACTIVE_PRESET = 'MORE_TRAIN'  # –í—ã–±–µ—Ä–∏—Ç–µ: BASELINE, MORE_TRAIN, REGULARIZED, NO_TICKER


def get_active_config():
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∞–∫—Ç–∏–≤–Ω—É—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é."""
    presets = {
        'BASELINE': PRESET_BASELINE,
        'MORE_TRAIN': PRESET_MORE_TRAIN,
        'REGULARIZED': PRESET_REGULARIZED,
        'NO_TICKER': PRESET_NO_TICKER,
    }
    return presets.get(ACTIVE_PRESET, PRESET_BASELINE)


# ============================================================================
# üîç –í–´–í–û–î –¢–ï–ö–£–©–ï–ô –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–ò
# ============================================================================

if __name__ == "__main__":
    print("=" * 60)
    print("üéõÔ∏è –¢–ï–ö–£–©–ê–Ø –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø –û–ë–£–ß–ï–ù–ò–Ø")
    print("=" * 60)
    
    config = get_active_config()
    print(f"\nüìå –ê–∫—Ç–∏–≤–Ω—ã–π –ø—Ä–µ—Å–µ—Ç: {ACTIVE_PRESET}")
    print(f"\nüìÖ Train/Test Split:")
    print(f"   Cutoff –¥–∞—Ç–∞: {config.get('train_cutoff', TRAIN_CUTOFF_DATE)}")
    
    print(f"\nüå≥ LightGBM –ø–∞—Ä–∞–º–µ—Ç—Ä—ã:")
    for key in ['num_leaves', 'learning_rate', 'lambda_l1', 'lambda_l2', 'min_child_samples']:
        value = config.get(key, LGBM_PARAMS.get(key))
        print(f"   {key}: {value}")
    
    print(f"\nüéØ Target: {TARGET_COL}")
    print(f"üìä Quantiles: {QUANTILES}")
    
    if EXCLUDE_TICKERS:
        print(f"\nüö´ –ò—Å–∫–ª—é—á—ë–Ω–Ω—ã–µ —Ç–∏–∫–µ—Ä—ã: {EXCLUDE_TICKERS}")
    
    print("\n" + "=" * 60)

