# Архитектура модели прогнозирования волатильности (As-is)

Документация описывает текущее состояние пайплайна машинного обучения для проекта MOEXScanner. Схема включает этапы от загрузки данных до интерпретации моделей.

---

## 1. Модуль: Загрузка и предобработка данных (Data Loading)
**Файл:** `ML/01_data_loading.ipynb`

### Входные данные
- **Источник:** Локальные CSV файлы в структуре папок `data/MOEX_DATA/{Тикер}/{Таймфрейм}/`.
- **Формат:** OHLCV (Open, High, Low, Close, Volume), поля `begin`/`end` для времени.

### Процессы
1. **Поиск данных:** Скрипт сканирует директории для заданного списка тикеров (SBER, GAZP, LKOH и др.).
2. **Парсинг дат:** Преобразование строковых полей `begin`/`end` в `datetime`.
3. **Расчет доходностей:**
   - Вычисляются логарифмические доходности: `log_return = log(Price_t / Price_{t-1})`.
   - Используются цены закрытия (`close`).
4. **Очистка:** Удаление пропусков (NaN), возникающих из-за лагов (shift).

### Выходные данные
- **Файлы:** `data/processed/{ticker}_ohlcv_returns.parquet`
- **Состав:** Базовые свечные данные + колонка `log_return`.

---

## 2. Модуль: Генерация признаков (Feature Engineering)
**Папка:** `ML/02_feature_engineering/`

### 2.1 Признаки волатильности (Volatility Features)
**Файл:** `ML/02_feature_engineering/01_volatility_features.ipynb`
> **Примечание:** В данном модуле планируется пересмотр набора фич (по запросу пользователя). Текущая реализация описана ниже.

**Вход:** `data/processed/{ticker}_ohlcv_returns.parquet`

**Процессы (расчет метрик):**
1. **Realized Volatility:** Скользящее стандартное отклонение `log_return` (окна: 10, 30, 60). Масштабируется на `sqrt(252)`.
2. **EWMA Volatility:** Экспоненциально взвешенное скользящее среднее стандартное отклонение (спаны: 10, 30, 60).
3. **Parkinson Volatility:** Оценка на основе размаха High-Low. Более эффективна для внутридневных данных.
4. **Garman-Klass Volatility:** Оценка на основе OHLC. Учитывает открытия и закрытия, более точная оценка, чем Parkinson.
5. **Directional Volatility:** (Опционально в коде) Раздельная волатильность для растущих и падающих свечей.

**Выход:** `data/features/{ticker}_volatility_features.parquet` (промежуточный датасет).

### 2.2 Целевые переменные (Targets)
**Файл:** `ML/02_feature_engineering/05_targets.ipynb`

**Вход:** Датасет с признаками (или базовый `ohlcv_returns`).

**Процессы:**
1. **Target Volatility:** Реализованная волатильность, сдвинутая в будущее на горизонт прогноза (1, 5, 10 дней). `shift(-horizon)`.
2. **Spike Flag:** Бинарный признак всплеска волатильности (1, если будущая доходность отклоняется более чем на 2 сигмы от скользящего среднего).
3. **Quantiles:** Квантили (16%, 50%, 84%) будущего распределения доходностей (для QR моделей).
4. **Direction:** Направление движения цены (1 - рост, 0 - падение) на горизонте прогноза.

**Выход:** `data/features/{ticker}_with_targets.parquet` — итоговый датасет для обучения.

*(Также в папке присутствуют файлы для генерации признаков объема, рыночных и трендовых факторов, которые интегрируются в общий пайплайн аналогичным образом).*

---

## 3. Модуль: Моделирование (Modeling)
**Папка:** `ML/03_models/`

### 3.1 Базовые модели (Baseline)
**Файл:** `ML/03_models/01_baseline_models.ipynb`

**Вход:** `data/features/{ticker}_with_targets.parquet`

**Процессы:**
1. **Naive Forecast:** Прогноз на завтра равен значению волатильности сегодня. Используется как нижняя планка качества.
2. **EWMA Forecast:** Прогноз равен значению экспоненциальной скользящей средней.
3. **Оценка:** Расчет метрик MAE (Mean Absolute Error) и RMSE (Root Mean Squared Error) на отложенной выборке или всем датасете.

**Выход:**
- Файлы прогнозов: `data/models/{ticker}_baseline_forecasts.parquet`
- Метрики: `data/models/{ticker}_baseline_metrics.csv`

*(Другие модели: GARCH, LightGBM Quantile, Ensemble - реализуют более сложные алгоритмы прогнозирования условной дисперсии).*

---

## 4. Модуль: Бэктестинг (Backtesting)
**Папка:** `ML/04_backtesting/`

**Процессы:**
- **Генерация сигналов:** Преобразование прогнозов волатильности в торговые сигналы (например, расширение/сужение каналов Боллинджера, фильтрация входов при высокой волатильности).
- **Симуляция:** Прогон сигналов на исторических данных с учетом комиссий.
- **Анализ:** Расчет Sharpe Ratio, Drawdown, Profit Factor.

---

## 5. Модуль: Интерпретируемость (Explainability)
**Папка:** `ML/05_explainability/`

**Процессы:**
- **SHAP Values:** Анализ вклада каждого признака (лагов волатильности, объемов) в итоговый прогноз модели.
- **Feature Importance:** Глобальная оценка важности признаков для отбора лучших предикторов.

